<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LISTÔΩú„Çø„Çπ„ÇØ‰∏ÄË¶ß</title>
    <style>
        body {
            font-family: -apple-system, system-ui;
            margin: 0;
            background: #f7f7f8;
        }

        header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }

        .bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }

        .tab {
            padding: 6px 12px;
            border-radius: 14px;
            border: 1px solid #ddd;
            font-size: 13px;
            cursor: pointer;
        }

            .tab.active {
                background: #111;
                color: white;
                border-color: #111;
            }

        .add {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
        }

            .add input {
                flex: 1;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #ddd;
                font-size: 16px; /* iOS„ÅÆÂãùÊâã„Ç∫„Éº„É†Èò≤Ê≠¢ */
            }

        .list {
            display: flex;
            flex-direction: column;
        }

        .card {
            position: relative;
            background: white;
            border-bottom: 1px solid #eee;
            height: 60px;
            overflow: hidden;
            touch-action: pan-y;
            box-sizing: border-box;
        }

            .card.completed .title {
                color: #aaa;
                text-decoration: line-through;
            }

            .card.dragging {
                opacity: 0.95;
                box-shadow: 0 8px 24px rgba(0,0,0,0.25);
                z-index: 100;
                transform: scale(1.02);
                background: #fff;
            }

            .card.drag-placeholder {
                background: #f0f0f0;
                border: 2px dashed #ccc;
                box-sizing: border-box;
            }

            .card.drag-placeholder .sl,
            .card.drag-placeholder .actions-rail {
                visibility: hidden;
            }

        .sl {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 12px;
            transition: transform .15s ease;
            background: white;
            z-index: 2;
            box-sizing: border-box;
        }

        .actions-rail {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 1;
        }

        /* „Çπ„ÉØ„Ç§„Éó„ÅßÈñã„ÅÑ„Å¶„ÅÑ„Çã„Å®„Åç„Å†„Åë„Éú„Çø„É≥„ÇíÊäº„Åõ„Çã„Çà„ÅÜ„Å´„Åô„Çã */
        .card.open-left .actions-rail,
        .card.open-right .actions-rail {
            pointer-events: auto;
        }

        .actions-left, .actions-right {
            height: 100%;
            display: flex;
            align-items: center;
        }

        .actions-left {
            background: #e8f7ee;
            justify-content: flex-start;
            padding-left: 0;
        }

        .actions-right {
            background: #fdeeee;
            justify-content: flex-end;
            padding-right: 0;
        }

        .actions-rail button {
            height: 100%;
            min-width: 64px;
            border: none;
            color: white;
            font-size: 13px;
            border-radius: 0;
            cursor: pointer;
        }

        .btn-complete {
            background: #7e6dff;
        }

        .btn-plus2h {
            background: #8012e2;
        }

        .btn-detail {
            background: #1e928b;
        }

        .btn-pin {
            background: #d97706;
        }

        .btn-delete {
            background: #f03d30;
        }

        .title {
            font-size: 15px;
        }

        .handle {
            margin-left: auto;
            cursor: grab;
            opacity: 0.25;
            -webkit-user-select: none;
            user-select: none;
            padding: 0 8px;
            font-size: 20px;
            touch-action: none;
        }

        .divider-label {
            text-align: center;
            color: #888;
            font-size: 12px;
            padding: 6px 0;
        }

        /* Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ */
        .modal-root {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 50;
            align-items: flex-end;
            justify-content: center;
        }

            .modal-root.visible {
                display: flex;
            }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.25);
            z-index: 0;
        }

        .modal-panel {
            width: 100%;
            max-width: 480px;
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 16px;
            animation: slideUp .18s ease-out;
            position: relative;
            z-index: 1;
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slider-group {
            margin: 14px 0;
        }

        .slider-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

            .slider-label-row span.value {
                font-size: 13px;
                font-weight: 600;
            }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 14px;
        }

        .btn-secondary {
            padding: 8px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: #fafafa;
            cursor: pointer;
        }

        .btn-primary-solid {
            padding: 8px 16px;
            border-radius: 20px;
            background: #7e6dff;
            color: white;
            border: none;
            cursor: pointer;
        }

        .remindAt {
            font-size: 11px;
            color: #666;
            margin-left: 8px;
            white-space: nowrap;
        }
    </style>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <header>
        <div class="bar">
            <div style="font-weight:600">LIST</div>
            <div class="tab active">„Çø„Çπ„ÇØ</div>
            <div class="tab" id="refreshBtn">‚Üª</div>
        </div>
    </header>

    <main>
        <div class="add">
            <input id="newTitle" placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ‚Ä¶" />
            <button id="btnAdd" class="tab" style="background:#111;color:white;border-color:#111">ËøΩÂä†</button>
        </div>

        <div class="divider-label">ToDo„Çø„Çπ„ÇØ</div>
        <div id="pinned" class="list"></div>
        <div id="active" class="list"></div>

        <div class="divider-label" style="margin-top:16px;">--------------------------------------------------------------------<br>ÈÅîÊàê„Çø„Çπ„ÇØ</div>
        <div id="completed" class="list"></div>
    </main>

    <!-- Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:600">„Çø„Çπ„ÇØË©≥Á¥∞</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
            </div>

            <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

            <!-- „Çπ„Ç≥„Ç¢Ë®≠ÂÆö„Ç∞„É´„Éº„ÉóÔºàË©≥Á¥∞„É¢„Éº„ÉâÁî®Ôºâ -->
            <div id="scoreGroup">
                <div class="slider-group">
                    <div class="slider-label-row"><span>ÂÑ™ÂÖàÂ∫¶</span><span class="value" id="valPriority"></span></div>
                    <input id="inputPriority" type="range" min="0" max="10" step="1" />
                </div>

                <div class="slider-group">
                    <div class="slider-label-row"><span>„Éì„Ç∏„Éß„É≥Èñ¢ÈÄ£Â∫¶</span><span class="value" id="valVision"></span></div>
                    <input id="inputVision" type="range" min="0" max="10" step="1" />
                </div>

                <div class="slider-group">
                    <div class="slider-label-row"><span>„Çè„Åè„Çè„ÅèÂ∫¶</span><span class="value" id="valExcite"></span></div>
                    <input id="inputExcite" type="range" min="0" max="10" step="1" />
                </div>

                <div class="slider-group">
                    <div class="slider-label-row"><span>ÊàêÈï∑Â∫¶</span><span class="value" id="valGrowth"></span></div>
                    <input id="inputGrowth" type="range" min="0" max="10" step="1" />
                </div>
            </div>

            <!-- „É™„Éû„Ç§„É≥„ÉâÊó•ÊôÇ„Ç∞„É´„Éº„ÉóÔºàÈÄöÁü•„É¢„Éº„ÉâÁî®Ôºâ -->
            <div id="remindGroup" class="slider-group">
                <div class="slider-label-row">
                    <span>„É™„Éû„Ç§„É≥„ÉâÊó•ÊôÇ</span>
                    <span class="value" id="valRemindAt"></span>
                </div>
                <input id="inputRemindAt" type="datetime-local" />
            </div>

            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="detailSaveBtn" class="btn-primary-solid">‰øùÂ≠ò</button>
            </div>

        </div>
    </div>

    <script>
        const LIFF_ID = "2008277838-gcAH7Vyk";
        const API_BASE = "https://lumicreate.xvps.jp/webhook";
        let userId = null;
        let currentDetailTask = null;
        let modalMode = "detail"; // "detail" or "remind"

        // Âº∑„Çπ„ÉØ„Ç§„ÉóÂà§ÂÆö„ÅÆÊØîÁéá
        const STRONG_RATIO = 0.85;  // „Éú„Çø„É≥ÂπÖ„ÅÆÁ¥Ñ85%‰ª•‰∏ä
        const SNAP_THRESHOLD = 40;  // „Åì„ÅÆpx‰ª•‰∏ä„Åß„ÄåÈñã„Åè„Äç„Çπ„Éä„ÉÉ„Éó

        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„Éï„É©„Ç∞Ôºà„Çπ„ÉØ„Ç§„Éó„ÇíÁÑ°ÂäπÂåñ„Åô„Çã„Åü„ÇÅÔºâ
        let isDraggingCard = false;

        // DOM„Ç≠„É£„ÉÉ„Ç∑„É•
        const pinnedEl = document.getElementById("pinned");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");
        const refreshBtn = document.getElementById("refreshBtn");
        const btnAdd = document.getElementById("btnAdd");
        const newTitle = document.getElementById("newTitle");

        // „É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥†
        const detailModal = document.getElementById("detailModal");
        const detailBackdrop = document.getElementById("detailBackdrop");
        const detailCloseBtn = document.getElementById("detailCloseBtn");
        const detailCancelBtn = document.getElementById("detailCancelBtn");
        const detailSaveBtn = document.getElementById("detailSaveBtn");
        const detailTaskTitle = document.getElementById("detailTaskTitle");

        const inputPriority = document.getElementById("inputPriority");
        const inputVision = document.getElementById("inputVision");
        const inputExcite = document.getElementById("inputExcite");
        const inputGrowth = document.getElementById("inputGrowth");
        const valPriority = document.getElementById("valPriority");
        const valVision = document.getElementById("valVision");
        const valExcite = document.getElementById("valExcite");
        const valGrowth = document.getElementById("valGrowth");

        const inputRemindAt = document.getElementById("inputRemindAt"); // ‚òÖËøΩÂä†
        const valRemindAt = document.getElementById("valRemindAt");     // ‚òÖËøΩÂä†

        // ‚òÖ „Ç∞„É´„Éº„ÉóË¶ÅÁ¥†ÔºàË°®Á§∫Âàá„ÇäÊõø„ÅàÁî®Ôºâ
        const scoreGroup = document.getElementById("scoreGroup");
        const remindGroup = document.getElementById("remindGroup");
        const modalTitle = document.querySelector("#detailModal .modal-panel > div:first-child > div:first-child");


        function toLocalDatetimeValue(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const hh = String(d.getHours()).padStart(2, "0");
            const mi = String(d.getMinutes()).padStart(2, "0");
            return `${yyyy}-${mm}-${dd}T${hh}:${mi}`; // datetime-local Áî®
        }

        /*„Åì„Åì„Åß„ÅÑ„ÅÑ„ÅÆ„Åã„Å™...?üëá*/
        function formatRemindLabel(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const hh = String(d.getHours()).padStart(2, "0");
            const mi = String(d.getMinutes()).padStart(2, "0");
            return `üîî${yyyy}/${mm}/${dd} ${hh}:${mi}`; // Ë°®Á§∫Áî®
        }

        /* ==========================
           INIT
        ========================== */
        async function init() {
            try {
                // LIFF SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                if (typeof liff === "undefined") {
                    console.error("[INIT] LIFF SDK not loaded");
                    alert("LIFF SDK„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                    return;
                }

                console.log("[INIT] Starting LIFF init with ID:", LIFF_ID);
                await liff.init({ liffId: LIFF_ID });
                console.log("[INIT] LIFF initialized successfully");

                // LIFFÁí∞Â¢É„Åã„Å©„ÅÜ„ÅãÁ¢∫Ë™ç
                const isInClient = liff.isInClient();
                console.log("[INIT] isInClient:", isInClient);

                if (!liff.isLoggedIn()) {
                    console.log("[INIT] Not logged in, redirecting to login...");
                    liff.login();
                    return;
                }

                console.log("[INIT] Already logged in, getting profile...");
                const profile = await liff.getProfile();
                userId = profile.userId;
                console.log("[INIT] Got userId:", userId);

                bindUI();
                bindModalUI();
                await loadList();
            } catch (e) {
                console.error("[INIT] Error:", e);
                // „Ç®„É©„Éº„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
                let errorMsg = "LIFFÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n";
                if (e.code) {
                    errorMsg += `„Ç®„É©„Éº„Ç≥„Éº„Éâ: ${e.code}\n`;
                }
                if (e.message) {
                    errorMsg += `Ë©≥Á¥∞: ${e.message}`;
                }
                alert(errorMsg);
            }
        }

        /* ==========================
           bindUI
        ========================== */
        function bindUI() {
            refreshBtn.onclick = loadList;

            btnAdd.onclick = async () => {
                const title = newTitle.value.trim();
                if (!title) return;
                await action("create", null, { task_name: title });
                newTitle.value = "";
            };
        }

        /* ==========================
          Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ UI
        ========================== */
        function bindModalUI() {
            const close = () => detailModal.classList.remove("visible");

            detailBackdrop.onclick = close;
            detailCloseBtn.onclick = close;
            detailCancelBtn.onclick = close;

            const bindSlider = (input, label) => {
                input.addEventListener("input", () => { label.textContent = input.value; });
            };
            bindSlider(inputPriority, valPriority);
            bindSlider(inputVision, valVision);
            bindSlider(inputExcite, valExcite);
            bindSlider(inputGrowth, valGrowth);

            // ‚òÖ „É™„Éû„Ç§„É≥„ÉâÊó•ÊôÇ„ÅåÂ§âÊõ¥„Åï„Çå„Åü„ÇâÂè≥ÂÅ¥„ÅÆ„É©„Éô„É´Êõ¥Êñ∞Ôºà„É¢„Éº„ÉÄ„É´ÂÜÖÔºâ
            inputRemindAt.addEventListener("change", () => {
                if (inputRemindAt.value) {
                    const d = new Date(inputRemindAt.value);
                    valRemindAt.textContent = formatRemindLabel(d.toISOString());
                } else {
                    valRemindAt.textContent = "";
                }
            });

            detailSaveBtn.onclick = async () => {
                if (!currentDetailTask) return;

                if (modalMode === "detail") {
                    // ‚òÖ ÈÄöÂ∏∏„ÅÆ„ÄåË©≥Á¥∞„Äç„É¢„Éº„Éâ ‚Üí „Çπ„Ç≥„Ç¢„Å†„ÅëÊõ¥Êñ∞
                    const payload = {
                        priority: Number(inputPriority.value),
                        vision_score: Number(inputVision.value),
                        excite_score: Number(inputExcite.value),
                        growth_score: Number(inputGrowth.value),
                    };
                    await action("update_detail", currentDetailTask.id, payload);

                } else if (modalMode === "remind") {
                    // ‚òÖ „ÄåÈÄöÁü•„Äç„É¢„Éº„Éâ ‚Üí ÂÖ•Âäõ„ÅåÁ©∫„Å™„Çâ NULL „Å´„É™„Çª„ÉÉ„Éà
                    let remind_at = null;

                    if (inputRemindAt.value) {
                        // Êó•ÊôÇ„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„Å®„Åç„Å†„Åë ISO „Å´Â§âÊèõ
                        const d = new Date(inputRemindAt.value);
                        remind_at = d.toISOString();
                    }

                    // ‚òÖ 1) „É≠„Éº„Ç´„É´„ÅÆ„Çø„Çπ„ÇØ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÊõ¥Êñ∞
                    currentDetailTask.remind_at = remind_at;

                    // ‚òÖ 2) ÂØæÂøú„Åô„Çã„Ç´„Éº„Éâ„ÅÆÂè≥ÂÅ¥„É©„Éô„É´„ÇíÂç≥ÊôÇÊõ¥Êñ∞
                    const card = document.querySelector(`.card[data-task-id="${currentDetailTask.id}"]`);
                    if (card) {
                        const rightBox = card.querySelector(".rightBox");
                        if (rightBox) {
                            let label = rightBox.querySelector(".remindAt");

                            if (remind_at) {
                                // Êó•ÊôÇ„ÅÇ„Çä ‚Üí „É©„Éô„É´„Çí‰Ωú„Çã/Êõ¥Êñ∞
                                if (!label) {
                                    label = document.createElement("div");
                                    label.className = "remindAt";
                                    const handleEl = rightBox.querySelector(".handle");
                                    rightBox.insertBefore(label, handleEl || null);
                                }
                                label.textContent = formatRemindLabel(remind_at);
                            } else {
                                // Êó•ÊôÇ„Å™„ÅóÔºà„É™„Çª„ÉÉ„ÉàÔºâ‚Üí „É©„Éô„É´„ÇíÊ∂à„Åô
                                if (label) {
                                    label.remove();
                                }
                            }
                        }
                    }

                    // ‚òÖ 3) „Çµ„Éº„Éê„ÉºÂÅ¥„Å´„ÇÇ‰øùÂ≠ò
                    await action("remind_custom", currentDetailTask.id, {
                        remind_at,                             // null „ÇÇ„Åù„ÅÆ„Åæ„ÅæÈÄÅ„Çã
                        kind: remind_at ? "custom_datetime" : "clear",
                    });
                }


                // ÊúÄÂæå„Å´„É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
                close();
            };
        }

        /* ==========================
          LIST API
        ========================== */
        async function loadList() {
            const url = `${API_BASE}/list?user_id=${encodeURIComponent(userId)}`;
            console.log("[LIST] request:", url);

            try {
                const res = await fetch(url);
                console.log("[LIST] status:", res.status);

                const text = await res.text();
                console.log("[LIST] raw response:", JSON.stringify(text));

                if (!res.ok) {
                    console.error("[LIST] http error:", res.status, text);
                    alert("„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàHTTP„Ç®„É©„ÉºÔºâ");
                    return;
                }

                if (!text) {
                    console.warn("[LIST] Á©∫„É¨„Çπ„Éù„É≥„Çπ„Åß„Åó„Åü");
                    renderList({ pinned: [], active: [], completed: [] });
                    return;
                }

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("[LIST] JSON„Éë„Éº„Çπ„Ç®„É©„Éº:", e);
                    alert("„Çµ„Éº„Éê„Éº„Åã„ÇâJSON„ÅåËøî„Å£„Å¶„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    return;
                }

                console.log("[LIST] parsed json:", data);
                renderList(data);

            } catch (e) {
                console.error("[LIST] fetch error:", e);
                alert("„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàÈÄö‰ø°„Ç®„É©„ÉºÔºâ");
            }
        }

        function renderList(payload) {
            pinnedEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            const pinned = Array.isArray(payload.pinned) ? payload.pinned : [];
            const active = Array.isArray(payload.active) ? payload.active : [];
            const completed = Array.isArray(payload.completed) ? payload.completed : [];

            pinned.forEach(t => pinnedEl.appendChild(taskCard(t, false)));
            active.forEach(t => activeEl.appendChild(taskCard(t, false)));
            completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        /* ==========================
          ‰∏¶„Å≥È†Ü„Çí„Çµ„Éº„Éê„Éº„Å∏‰øùÂ≠ò
        ========================== */
        async function saveSortOrder() {
            if (!userId) return;

            const orders = [];

            pinnedEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "pinned" });
            });
            activeEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "active" });
            });
            completedEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "completed" });
            });

            console.log("[SORT_UPDATE] orders:", orders);
            await action("sort_update", null, { orders });
        }

        /* ==========================
          TASK CARD
        ========================== */
        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            if (isCompleted) wrap.classList.add("completed");

            // ËÉåÈù¢„É¨„Éº„É´
            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";

            if (!isCompleted) {
                left.append(
                    mkBtn("ÂÆå‰∫Ü", () => action("complete", t.id), "btn-complete"),
                    // ‚òÖ „ÄåÈÄöÁü•„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Åü„Çâ openRemind(t) „ÇíÂëº„Å∂
                    mkBtn("ÈÄöÁü•", () => openRemind(t), "btn-plus2h")
                );
            } else {
                left.append(mkBtn("Êú™ÂÆå", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn(t.pinned ? "üìçËß£Èô§" : "üìç„Éî„É≥", () => action("toggle_pin", t.id), "btn-pin"),
                mkBtn("ÂâäÈô§", () => {
                    if (t.pinned) return alert("„Éî„É≥„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                    action("delete", t.id);
                }, "btn-delete")
            );

            rail.append(left, right);

            // ÂâçÈù¢
            const sl = document.createElement("div");
            sl.className = "sl";

            const titleEl = document.createElement("div");
            titleEl.className = "title";

            const name = t.task_name || t.title || "(ÁÑ°È°å)";
            titleEl.textContent = t.pinned ? "üìç " + name : name;

            // Â∑¶Ôºà„Çø„Ç§„Éà„É´Ôºâ„Å®Âè≥Ôºà„É™„Éû„Ç§„É≥„ÉâÔºã„Éè„É≥„Éâ„É´Ôºâ„Å´ÂàÜÂâ≤
            const leftBox = document.createElement("div");
            leftBox.style.flex = "1";
            leftBox.appendChild(titleEl);

            const rightBox = document.createElement("div");
            rightBox.className = "rightBox";           // ‚òÖ ËøΩÂä†
            rightBox.style.display = "flex";
            rightBox.style.alignItems = "center";

            if (t.remind_at) {
                const remindEl = document.createElement("div");
                remindEl.className = "remindAt";
                remindEl.textContent = formatRemindLabel(t.remind_at);
                rightBox.appendChild(remindEl);
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "‚ò∞";
            handle.style.marginLeft = "8px";

            rightBox.appendChild(handle);

            sl.append(leftBox, rightBox);
            wrap.append(rail, sl);


            // ===== „Éú„Çø„É≥ÂπÖ„ÇíÊ∏¨„Å£„Å¶ data „Å´‰øùÂ≠òÔºàÁ´Ø„ÇíÊèÉ„Åà„ÇãÁî®Ôºâ =====
            requestAnimationFrame(() => {
                const lRect = left.getBoundingClientRect();
                const rRect = right.getBoundingClientRect();
                wrap.dataset.leftWidth = lRect.width || 140;
                wrap.dataset.rightWidth = rRect.width || 140;
            });

            // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßãÁî®„ÅÆ„Çø„Ç§„Éû„Éº„ÅØ‰∏çË¶ÅÔºàÂç≥Â∫ß„Å´„Éâ„É©„ÉÉ„Ç∞ÈñãÂßãÔºâ


            /* ==========================
                PCÁâà „ÇØ„É™„ÉÉ„ÇØ„Åß„Çπ„ÉØ„Ç§„Éó
            ========================== */
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", e => {
                    const rect = sl.getBoundingClientRect();
                    const x = e.clientX - rect.left;

                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;

                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }

                    if (x < rect.width / 2) {
                        wrap.classList.add("open-left");
                        wrap.classList.remove("open-right");
                        sl.style.transform = `translateX(${leftW}px)`;
                    } else {
                        wrap.classList.add("open-right");
                        wrap.classList.remove("open-left");
                        sl.style.transform = `translateX(${-rightW}px)`;
                    }
                });
            }

            /* ==========================
                „Çπ„Éû„ÉõÁâà „Çπ„ÉØ„Ç§„Éó
            ========================== */
            let startX = 0, startY = 0, dx = 0, dy = 0;
            let isHandleDrag = false;  // ‚Üê ËøΩÂä†Ôºö‚ò∞ „Åã„ÇâÂßã„Åæ„Å£„Åü„Åã„Å©„ÅÜ„Åã
            let isScrolling = null;    // null=Êú™Á¢∫ÂÆö, true=Á∏¶„Çπ„ÇØ„É≠„Éº„É´ÂÑ™‰Ωç, false=Ê®™„Çπ„É©„Ç§„ÉâÂÑ™‰Ωç

            wrap.addEventListener("touchstart", e => {
                // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØ„Çπ„ÉØ„Ç§„Éó„ÇíÁÑ°ÂäπÂåñ
                if (isDraggingCard) {
                    return;
                }

                // „Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜ„ÇíËµ∑Âãï„Åó„Å™„ÅÑ
                if (e.target.closest("button")) {
                    return;
                }

                // ‚ò∞Ôºà.handleÔºâ„Åã„ÇâÂßã„Åæ„Å£„Åü„Çø„ÉÉ„ÉÅ„Å™„Çâ„ÄÅ„Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜ„ÅØ‰∏ÄÂàá„Åó„Å™„ÅÑ
                if (e.target.closest(".handle")) {
                    isHandleDrag = true;
                    return;
                } else {
                    isHandleDrag = false;
                }

                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                dx = 0;
                dy = 0;
                isScrolling = null;  // ÊñπÂêëÊú™Á¢∫ÂÆö
                sl.style.transition = "none";
            }, { passive: true });

            wrap.addEventListener("touchmove", e => {
                if (isHandleDrag) {
                    // ‚ò∞ „Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Çã„Å®„Åç„ÅØ„ÄÅ„Åì„ÅìÔºàÊ®™„Çπ„ÉØ„Ç§„ÉóÔºâ„Å´„ÅØÂÖ•„Çâ„Å™„ÅÑ
                    return;
                }
                if (e.touches.length === 0) return;

                dx = e.touches[0].clientX - startX;
                dy = e.touches[0].clientY - startY;

                // ÊñπÂêë„Åå„Åæ„Å†Á¢∫ÂÆö„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÄÅ‰∏ÄÂÆöË∑ùÈõ¢Âãï„ÅÑ„Åü„ÇâÂà§ÂÆö
                if (isScrolling === null && (Math.abs(dx) > 8 || Math.abs(dy) > 8)) {
                    // Á∏¶ÊñπÂêë„ÅÆÁßªÂãï„ÅåÊ®™ÊñπÂêë„Çà„ÇäÂ§ß„Åç„ÅÑÂ†¥Âêà„ÅØÁ∏¶„Çπ„ÇØ„É≠„Éº„É´ÂÑ™‰Ωç
                    isScrolling = Math.abs(dy) > Math.abs(dx);
                }

                // Á∏¶„Çπ„ÇØ„É≠„Éº„É´ÂÑ™‰Ωç„ÅÆÂ†¥Âêà„ÅØÊ®™„Çπ„É©„Ç§„Éâ„Åó„Å™„ÅÑ
                if (isScrolling) {
                    return;
                }

                // Ê®™„Çπ„É©„Ç§„ÉâÂÑ™‰Ωç„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
                if (Math.abs(dx) > 8) e.preventDefault();
                sl.style.transform = `translateX(${dx}px)`;
            }, { passive: false });

            wrap.addEventListener("touchend", () => {
                // ‚ò∞ „Éâ„É©„ÉÉ„Ç∞„Å†„Å£„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Çπ„ÉØ„Ç§„Éó„ÅÆÂæåÂá¶ÁêÜ„Çí„Åó„Å™„ÅÑ
                if (isHandleDrag) {
                    isHandleDrag = false;
                    sl.style.transition = "";
                    sl.style.transform = "translateX(0)";
                    return;
                }

                // Á∏¶„Çπ„ÇØ„É≠„Éº„É´ÂÑ™‰Ωç„Å†„Å£„ÅüÂ†¥Âêà„ÇÇÊ®™„Çπ„É©„Ç§„Éâ„ÅÆÂæåÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó
                if (isScrolling) {
                    sl.style.transition = "";
                    sl.style.transform = "translateX(0)";
                    return;
                }

                sl.style.transition = "transform .15s";

                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;

                const leftStrong = leftW * STRONG_RATIO;
                const rightStrong = rightW * STRONG_RATIO;

                // „Åì„Åì‰ª•‰∏ã„ÅØ‰ªä„ÅÆ„Åæ„Åæ„ÅÆÂº∑„Çπ„ÉØ„Ç§„ÉóÂà§ÂÆö„ÅßOK
                if (dx > leftStrong) {
                    if (!isCompleted) {
                        action("complete", t.id);
                    } else {
                        action("uncomplete", t.id);
                    }
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                    return;
                }
                if (dx < -rightStrong) {
                    if (t.pinned) {
                        alert("„Éî„É≥„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                    } else {
                        action("delete", t.id);
                    }
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                    return;
                }

                if (dx > SNAP_THRESHOLD) {
                    wrap.classList.add("open-left");
                    wrap.classList.remove("open-right");
                    sl.style.transform = `translateX(${leftW}px)`;
                } else if (dx < -SNAP_THRESHOLD) {
                    wrap.classList.add("open-right");
                    wrap.classList.remove("open-left");
                    sl.style.transform = `translateX(${-rightW}px)`;
                } else {
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                }
            });

            /* ==========================
                ‚ò∞ „Åß‰∏¶„Å≥Êõø„ÅàÔºà„Éâ„É©„ÉÉ„Ç∞Ôºâ - ÊîπÂñÑÁâà
            ========================== */
            const startDrag = (startEvent) => {
                startEvent.preventDefault();
                startEvent.stopPropagation();

                const card = wrap;
                const list = card.parentElement;
                if (!list) return;

                // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã„Éï„É©„Ç∞„ÇíON
                isDraggingCard = true;

                // ÂàùÊúü‰ΩçÁΩÆ„ÇíË®òÈå≤
                const cardRect = card.getBoundingClientRect();
                const startY = startEvent.clientY || (startEvent.touches && startEvent.touches[0].clientY);
                const cardStartTop = cardRect.top;
                const cardHeight = cardRect.height;

                // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Çí‰ΩúÊàêÔºàÂÖÉ„ÅÆ‰ΩçÁΩÆ„ÇíÁ§∫„ÅôÔºâ
                const placeholder = document.createElement("div");
                placeholder.className = "card drag-placeholder";
                placeholder.style.height = cardHeight + "px";
                list.insertBefore(placeholder, card);

                // „Ç´„Éº„Éâ„ÇíÊµÆ„Åã„Åõ„ÇãÔºàposition: fixed „ÅßÁîªÈù¢„Å´Âõ∫ÂÆöÔºâ
                card.classList.add("dragging");
                card.style.position = "fixed";
                card.style.left = cardRect.left + "px";
                card.style.top = cardRect.top + "px";
                card.style.width = cardRect.width + "px";
                card.style.height = cardHeight + "px";
                card.style.pointerEvents = "none";

                document.body.style.userSelect = "none";
                document.body.appendChild(card); // body„Å´ÁßªÂãï„Åó„Å¶ÊúÄÂâçÈù¢„Å´

                const getY = (ev) => {
                    if (ev.touches && ev.touches.length > 0) {
                        return ev.touches[0].clientY;
                    }
                    return ev.clientY;
                };

                const onMove = (ev) => {
                    const currentY = getY(ev);
                    const deltaY = currentY - startY;

                    // „Ç´„Éº„Éâ„ÇíÊåá„Å´ËøΩÂæì„Åï„Åõ„Çã
                    card.style.top = (cardStartTop + deltaY) + "px";

                    // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                    const cardCenterY = cardStartTop + deltaY + cardHeight / 2;

                    // Âêå„Åò„É™„Çπ„ÉàÂÜÖ„ÅÆÂÖ®„Ç´„Éº„ÉâÔºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº‰ª•Â§ñÔºâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const siblings = Array.from(list.querySelectorAll(".card:not(.dragging)"));

                    for (let i = 0; i < siblings.length; i++) {
                        const sibling = siblings[i];
                        if (sibling === placeholder) continue;

                        const siblingRect = sibling.getBoundingClientRect();
                        const siblingCenterY = siblingRect.top + siblingRect.height / 2;

                        // „Ç´„Éº„Éâ„ÅÆ‰∏≠ÂøÉ„Ååsibling„ÅÆ‰∏≠ÂøÉ„Çà„Çä‰∏ä„Å™„Çâ„ÄÅ„Åù„ÅÆÂâç„Å´ÁßªÂãï
                        if (cardCenterY < siblingCenterY) {
                            if (placeholder.nextSibling !== sibling) {
                                list.insertBefore(placeholder, sibling);
                            }
                            return;
                        }
                    }

                    // ÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„Çà„Çä‰∏ã„Å™„Çâ„ÄÅÊúÄÂæå„Å´ÁßªÂãï
                    if (placeholder.nextSibling !== null) {
                        list.appendChild(placeholder);
                    }
                };

                const onUp = () => {
                    document.removeEventListener("pointermove", onMove);
                    document.removeEventListener("pointerup", onUp);
                    document.removeEventListener("touchmove", onMove);
                    document.removeEventListener("touchend", onUp);

                    // „Ç´„Éº„Éâ„Çí„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÅÆ‰ΩçÁΩÆ„Å´ÊåøÂÖ•
                    card.classList.remove("dragging");
                    card.style.position = "";
                    card.style.left = "";
                    card.style.top = "";
                    card.style.width = "";
                    card.style.height = "";
                    card.style.pointerEvents = "";

                    list.insertBefore(card, placeholder);
                    placeholder.remove();

                    document.body.style.userSelect = "";

                    // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü„Éï„É©„Ç∞„ÇíOFFÔºàÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶Ë™§‰ΩúÂãïÈò≤Ê≠¢Ôºâ
                    setTimeout(() => {
                        isDraggingCard = false;
                    }, 100);

                    saveSortOrder();
                };

                document.addEventListener("pointermove", onMove);
                document.addEventListener("pointerup", onUp);
                document.addEventListener("touchmove", onMove, { passive: false });
                document.addEventListener("touchend", onUp);
            };

            // PointerEvent„Å®TouchEvent„ÅÆ‰∏°Êñπ„Çí„Çµ„Éù„Éº„Éà
            handle.addEventListener("pointerdown", (e) => {
                e.preventDefault();
                startDrag(e);
            });
            handle.addEventListener("touchstart", (e) => {
                e.preventDefault();
                e.stopPropagation();
                startDrag(e);
            }, { passive: false });

            // ‰∏¶„Å≥Êõø„ÅàÁî®„Å´„Çø„Çπ„ÇØÊÉÖÂ†±„ÇíÁ¥ê‰ªò„Åë
            // ‰∏¶„Å≥Êõø„ÅàÁî®„Å´„Çø„Çπ„ÇØÊÉÖÂ†±„ÇíÁ¥ê‰ªò„Åë
            wrap.__taskData = t;
            wrap.dataset.taskId = t.id;   // ‚òÖ ËøΩÂä†ÔºöDOM„Åã„ÇâÈÄÜÂºï„Åç„Åô„ÇãÁî®

            return wrap;

        }

        /* ==========================
           MODAL OPEN
        ========================== */
        function openDetail(t) {
            modalMode = "detail";       // ‚òÖ „Åì„Åì„Åß„É¢„Éº„ÉâÊåáÂÆö
            currentDetailTask = t;

            const name = t.task_name || t.title || "(ÁÑ°È°å)";
            detailTaskTitle.textContent = name;
            modalTitle.textContent = "„Çø„Çπ„ÇØË©≥Á¥∞";  // ‚òÖ „É¢„Éº„ÉÄ„É´„Çø„Ç§„Éà„É´

            // ‚òÖ Ë°®Á§∫Âàá„ÇäÊõø„ÅàÔºö„Çπ„Ç≥„Ç¢„ÅÆ„ÅøË°®Á§∫„ÄÅ„É™„Éû„Ç§„É≥„Éâ„ÅØÈùûË°®Á§∫
            scoreGroup.style.display = "block";
            remindGroup.style.display = "none";

            inputPriority.value = t.priority ?? 0;
            valPriority.textContent = inputPriority.value;

            inputVision.value = t.vision_score ?? 0;
            valVision.textContent = inputVision.value;

            inputExcite.value = t.excite_score ?? 0;
            valExcite.textContent = inputExcite.value;

            inputGrowth.value = t.growth_score ?? 0;
            valGrowth.textContent = inputGrowth.value;

            detailModal.classList.add("visible");

        }

        function openRemind(t) {
            modalMode = "remind";        // ‚òÖ ÈÄöÁü•„É¢„Éº„Éâ
            currentDetailTask = t;

            const name = t.task_name || t.title || "(ÁÑ°È°å)";
            detailTaskTitle.textContent = name;
            modalTitle.textContent = "ÈÄöÁü•Ë®≠ÂÆö";  // ‚òÖ „É¢„Éº„ÉÄ„É´„Çø„Ç§„Éà„É´

            // ‚òÖ Ë°®Á§∫Âàá„ÇäÊõø„ÅàÔºö„É™„Éû„Ç§„É≥„Éâ„ÅÆ„ÅøË°®Á§∫„ÄÅ„Çπ„Ç≥„Ç¢„ÅØÈùûË°®Á§∫
            scoreGroup.style.display = "none";
            remindGroup.style.display = "block";

            // Êó¢„Å´remind_at„Åå„ÅÇ„Çå„Å∞ÂàùÊúüÂÄ§„Å®„Åó„Å¶ÂÖ•„Çå„Çã
            if (t.remind_at) {
                inputRemindAt.value = toLocalDatetimeValue(t.remind_at);
                valRemindAt.textContent = formatRemindLabel(t.remind_at);
            } else {
                inputRemindAt.value = "";
                valRemindAt.textContent = "";
            }

            detailModal.classList.add("visible");

        }

        /* ==========================
           BUTTON HELPER
        ========================== */
        function mkBtn(label, onClick, cls) {
            const b = document.createElement("button");
            b.textContent = label;
            if (cls) b.className = cls;

            const handler = (e) => {
                e.stopPropagation();
                e.preventDefault();
                onClick();
            };

            if ("ontouchend" in window) {
                b.addEventListener("touchend", handler, { passive: false });
            } else {
                b.addEventListener("click", handler);
            }

            return b;
        }

        /* ==========================
           API ACTION
        ========================== */
        async function action(kind, id, extra = {}) {
            const url = `${API_BASE}/action`;
            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: userId,
                        action: kind,
                        task_id: id,
                        ...extra
                    })
                });

                const text = await res.text();
                console.log("[ACTION]", kind, "status:", res.status, "resp:", text);

                if (!res.ok) {
                    alert("Êìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà" + res.status + "Ôºâ");
                    return;
                }
            } catch (e) {
                console.error("[ACTION] fetch error:", e);
                alert("ÈÄö‰ø°„Ç®„É©„Éº„ÅßÊìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            } finally {
                // ‚òÖ ÈÄöÁü•Ë®≠ÂÆö„ÅÆ„Å®„Åç„ÅØ„Éï„É≠„É≥„Éà„ÅßÁõ¥Êé•„É©„Éô„É´Êõ¥Êñ∞„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅßÂÜçË™≠„ÅøËæº„Åø„ÅØ„Åó„Å™„ÅÑ
                if (kind !== "remind_custom") {
                    loadList();
                }
            }
        }


        init();
    </script>
</body>
</html>
